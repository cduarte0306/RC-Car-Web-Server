<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RC Car Config – Web UI v{{ webui_version }} / Image v{{ version }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f7f7f8;
      --card: #ffffff;
      --ink: #111;
      --muted: #666;
      --ok: #16a34a;
      --warn: #f59e0b;
      --err: #dc2626;
      --border: #e5e7eb;
      --bar: #0ea5e9;
    }
    body { font-family: ui-sans-serif, system-ui, Arial; margin: 24px; background: var(--bg); color: var(--ink); }
    header { background:#111; color:#fff; padding:14px 16px; border-radius:12px; }
    main { margin-top: 20px; display: grid; gap: 16px; max-width: 720px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow: 0 1px 6px rgba(0,0,0,.05); }
    .card h2 { margin: 0 0 10px; font-size: 1.1rem; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    select, input[type="password"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:1rem; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #222; background:#111; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#fff; color:#111; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:.9rem; }
    #status { white-space: pre-wrap; }
    .hidden { display:none; }

    /* Tab styles */
    .tabs {
      display: flex;
      background: #333;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      margin-top: 20px;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      color: #fff;
      flex: 1;
      text-align: center;
      background: #333;
    }
    .tab.active { background: #555; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ---- Wi-Fi icon styles ---- */
    .wifi-wrap { display:flex; align-items:center; gap:10px; }
    .wifi {
      width: 28px; height: 22px; position: relative; display:inline-block;
      --wifi-color: #6b7280;
    }
    .wifi .dot, .wifi .arc {
      position: absolute; left: 50%; transform: translateX(-50%);
      background: var(--wifi-color);
    }
    .wifi .dot { bottom: 0; width: 6px; height: 6px; border-radius: 50%; }
    .wifi .arc { border-radius: 999px; }
    .wifi .a1 { bottom: 4px; width: 14px; height: 6px; }
    .wifi .a2 { bottom: 9px; width: 20px; height: 6px; }
    .wifi .a3 { bottom: 14px; width: 26px; height: 6px; }

    .wifi.connected { --wifi-color: var(--ok); }
    .wifi.scanning { --wifi-color: #475569; }
    .wifi.connecting { --wifi-color: var(--warn); }
    .wifi.error { --wifi-color: var(--err); }

    @keyframes wifi-pulse {
      0%   { opacity: .25; transform: translateX(-50%) scale(0.95); }
      30%  { opacity: .9;  transform: translateX(-50%) scale(1.02); }
      60%  { opacity: .5;  transform: translateX(-50%) scale(0.98); }
      100% { opacity: .25; transform: translateX(-50%) scale(0.95); }
    }
    .wifi.connecting .a1 { animation: wifi-pulse 0.9s ease-in-out infinite; }
    .wifi.connecting .a2 { animation: wifi-pulse 0.9s ease-in-out infinite 0.12s; }
    .wifi.connecting .a3 { animation: wifi-pulse 0.9s ease-in-out infinite 0.24s; }
    .wifi.scanning .a1 { animation: wifi-pulse 1.1s ease-in-out infinite; }
    .wifi.scanning .a2 { animation: wifi-pulse 1.1s ease-in-out infinite 0.12s; }
    .wifi.scanning .a3 { animation: wifi-pulse 1.1s ease-in-out infinite 0.24s; }

    @media (prefers-reduced-motion: reduce) {
      .wifi.connecting .a1,
      .wifi.connecting .a2,
      .wifi.connecting .a3,
      .wifi.scanning .a1,
      .wifi.scanning .a2,
      .wifi.scanning .a3 { animation: none; }
    }

    /* ---- SWU dropzone & progress ---- */
    .dropzone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 18px;
      text-align: center;
      background: #fafafa;
      transition: background .15s ease, border-color .15s ease;
    }
    .dropzone.dragover {
      background: #eef6ff;
      border-color: #60a5fa;
    }
    .file-row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
    .file-name { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .progress-wrap { margin-top:10px; height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress-bar { width:0%; height:100%; background: var(--bar); transition: width .15s ease; }
    .help { font-size:.85rem; color: var(--muted); margin-top:6px; }
    .status-ok { color: var(--ok); }
    .status-err { color: var(--err); }
    .log-terminal {
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 8px;
      margin-top: 8px;
      background: hsl(0, 43%, 99%);
      color: #020202;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>

  <!-- xterm.js CSS + JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>

</head>
<body>
  <header>
  <h1>
    Autonomous RC Car Configuration
    <small style="font-weight: normal; font-size: 1.0em;">
      Web UI v{{ webui_version }} • Image v{{ version }}
    </small>
  </h1>
</header>

  <div class="tabs">
    <div class="tab active" data-tab="status">Status</div>
    <div class="tab" data-tab="console">Console</div>
  </div>
  <div id="console" class="tab-content">
    <div class="card">
      <h2>Interactive Console</h2>
      <div id="terminal" style="height:400px;"></div>
    </div>
  </div>
  <div id="status" class="tab-content active"></div>
    <main>
      <!-- Wi-Fi Card -->
      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <div class="wifi-wrap">
            <div id="wifiIcon" class="wifi scanning" aria-label="Wi-Fi status" role="img" title="Wi-Fi">
              <span class="dot"></span>
              <span class="arc a1"></span>
              <span class="arc a2"></span>
              <span class="arc a3"></span>
            </div>
            <span class="muted" id="scanInfo">Click “Scan Wi-Fi” to list nearby networks.</span>
          </div>
          <button id="scanBtn" class="secondary">Scan Wi-Fi</button>
        </div>

        <div style="margin-top:12px;">
          <label for="ssid">Available Networks</label>
          <select id="ssid">
            <option value="" selected disabled>— No scan yet —</option>
          </select>
        </div>

        <div id="pwRow" class="hidden" style="margin-top:12px;">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter Wi-Fi password" />
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="connectBtn">Connect</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <!-- Software Update Card -->
      <div class="card" id="swuCard">
        <h2>Software Update (.swu)</h2>

        <div id="dropzone" class="dropzone" tabindex="0" aria-label="Drop .swu file here">
          <p><strong>Drag & drop</strong> your <code>.swu</code> file here, or
            <button id="chooseBtn" type="button" class="secondary">Choose file</button>
          </p>
          <input id="swuFile" type="file" accept=".swu" class="hidden" />
          <div class="help">Only .swu files are accepted.</div>
        </div>

        <div class="file-row hidden" id="fileRow">
          <div class="file-name" id="fileName"></div>
          <button id="clearFileBtn" type="button" class="secondary">Clear</button>
        </div>

        <div class="progress-wrap hidden" id="progressWrap" aria-hidden="true">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="uploadBtn" disabled>Upload</button>
          <button id="applyBtn" class="secondary" disabled>Apply Update</button>
          <span id="swuStatus" class="muted"></span>
        </div>
        <div id="swuLog" class="log-terminal">
          <!-- server messages will appear here -->
        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== Wi-Fi logic =====
    const scanBtn = document.getElementById('scanBtn');
    const ssidSelect = document.getElementById('ssid');
    const pwRow = document.getElementById('pwRow');
    const passwordInput = document.getElementById('password');
    const statusEl = document.getElementById('status');
    const scanInfo = document.getElementById('scanInfo');
    const wifiIcon = document.getElementById('wifiIcon');

    // ===== Tab switching =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    function setStatus(text) { statusEl.textContent = text; }
    function setScanInfo(text) { scanInfo.textContent = text; }

    function setWifiState(state) {
      wifiIcon.classList.remove('connected','connecting','scanning','error');
      if (state) wifiIcon.classList.add(state);
    }

    // ===== Terminal setup =====
    const term = new Terminal({ cursorBlink: true });
    term.open(document.getElementById('terminal'));
    term.write("Connecting to RC Car CLI...\r\n");

    // WebSocket to Flask backend
    const socket = new WebSocket("ws://" + window.location.host + "/ws/console");

    socket.onmessage = (ev) => term.write(ev.data);
    term.onData(data => socket.send(data));

    socket.onopen = () => term.write("Connected.\r\n");
    socket.onerror = () => term.write("\r\n[Error: connection failed]\r\n");

    async function scanWifi() {
      setStatus('');
      setScanInfo('Scanning…');
      setWifiState('scanning');
      try {
        const res = await fetch('/api/wifi/scan');
        if (!res.ok) throw new Error('Scan failed');
        const networks = await res.json();

        const best = new Map();
        for (const n of networks) {
          if (!n.ssid) continue;
          const prev = best.get(n.ssid);
          if (!prev || (n.signal ?? 0) > (prev.signal ?? 0)) best.set(n.ssid, n);
        }
        const list = [...best.values()].sort((a,b)=> (b.signal??0)-(a.signal??0));
        ssidSelect.innerHTML = '';
        if (list.length === 0) {
          ssidSelect.innerHTML = '<option value="" disabled selected>— No networks found —</option>';
        } else {
          for (const n of list) {
            const opt = document.createElement('option');
            const sec = n.security && n.security !== '--' ? n.security : 'OPEN';
            opt.value = n.ssid;
            opt.dataset.security = sec;
            opt.textContent = `${n.ssid}  ·  ${sec}  ·  ${n.signal ?? 0}%`;
            ssidSelect.appendChild(opt);
          }
          ssidSelect.selectedIndex = 0;
          updatePwVisibility();
        }
        setScanInfo(`Found ${list.length} network(s).`);
        setWifiState('scanning');
        setTimeout(()=> setWifiState(''), 800);
      } catch (e) {
        setScanInfo('Scan error.');
        setStatus('Error scanning Wi-Fi. Is NetworkManager/nmcli installed?');
        setWifiState('error');
      }
    }

    function updatePwVisibility() {
      const opt = ssidSelect.selectedOptions[0];
      if (!opt) { pwRow.classList.add('hidden'); return; }
      const sec = opt.dataset.security || 'OPEN';
      if (sec === 'OPEN') pwRow.classList.add('hidden'); else pwRow.classList.remove('hidden');
    }

    async function connectWifi() {
      const ssid = ssidSelect.value;
      if (!ssid) { setStatus('Please select a network.'); return; }
      const sec = ssidSelect.selectedOptions[0]?.dataset.security || 'OPEN';
      const password = passwordInput.value;

      if (sec !== 'OPEN' && !password) {
        setStatus('Password required for secured network.');
        return;
      }

      setStatus(`Connecting to "${ssid}"…`);
      setWifiState('connecting');

      try {
        const res = await fetch('/api/wifi/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ssid, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Connect failed');

        setStatus(`Connected to "${ssid}"${data.iface ? ` on ${data.iface}` : ''}${data.ip ? ` (IP: ${data.ip})` : ''}`);
        setWifiState('connected');
      } catch (e) {
        setStatus(`Failed to connect: ${e.message}`);
        setWifiState('error');
      }
    }

    scanBtn.addEventListener('click', scanWifi);
    ssidSelect.addEventListener('change', updatePwVisibility);
    document.getElementById('connectBtn').addEventListener('click', connectWifi);

    // ===== SWU upload logic (two-step: Upload -> Apply) =====
    const dropzone = document.getElementById('dropzone');
    const chooseBtn = document.getElementById('chooseBtn');
    const fileInput = document.getElementById('swuFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const applyBtn = document.getElementById('applyBtn');
    const swuStatus = document.getElementById('swuStatus');
    const fileRow = document.getElementById('fileRow');
    const fileNameEl = document.getElementById('fileName');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');

    let selectedFile = null;
    let uploadedMeta = null; // { filename, path } from server

    function isSWU(file) { return file && /\.swu$/i.test(file.name); }

    function prettySize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      const kb = bytes / 1024;
      if (kb < 1024) return `${kb.toFixed(1)} KB`;
      const mb = kb / 1024;
      if (mb < 1024) return `${mb.toFixed(1)} MB`;
      const gb = mb / 1024;
      return `${gb.toFixed(2)} GB`;
    }

    function setSWUStatus(msg, ok=false, err=false) {
      swuStatus.textContent = msg;
      swuStatus.classList.toggle('status-ok', ok);
      swuStatus.classList.toggle('status-err', err);
    }

    function setFile(file) {
      uploadedMeta = null;
      applyBtn.disabled = true;
      selectedFile = file;
      if (file) {
        fileRow.classList.remove('hidden');
        fileNameEl.textContent = `${file.name} (${prettySize(file.size)})`;
        uploadBtn.disabled = !isSWU(file);
        setSWUStatus(isSWU(file) ? 'Ready to upload.' : 'Only .swu files are allowed.',
                     isSWU(file), !isSWU(file));
      } else {
        fileRow.classList.add('hidden');
        fileNameEl.textContent = '';
        uploadBtn.disabled = true;
        setSWUStatus('');
      }
      resetProgress();
    }

    function resetProgress() {
      progressBar.style.width = '0%';
      progressWrap.classList.add('hidden');
      progressWrap.setAttribute('aria-hidden', 'true');
    }

    // Drag & drop
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files?.[0];
      if (!file) return;
      if (!isSWU(file)) { setFile(null); setSWUStatus('Invalid file type. Please select a .swu file.', false, true); return; }
      setFile(file);
    });

    chooseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!isSWU(file)) { setFile(null); setSWUStatus('Invalid file type. Please select a .swu file.', false, true); return; }
      setFile(file);
    });

    clearFileBtn.addEventListener('click', () => {
      fileInput.value = '';
      setFile(null);
    });

    // Upload button: sends file; enables Apply on success
    uploadBtn.addEventListener('click', () => {
      if (!selectedFile || !isSWU(selectedFile)) {
        setSWUStatus('Please select a .swu file first.', false, true);
        return;
      }

      const formData = new FormData();
      formData.append('file', selectedFile);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/swu/upload', true);

      xhr.upload.addEventListener('loadstart', () => {
        progressWrap.classList.remove('hidden');
        progressWrap.setAttribute('aria-hidden', 'false');
        progressBar.style.width = '0%';
        setSWUStatus('Uploading… 0%');
        uploadBtn.disabled = true;
        applyBtn.disabled = true;
      });

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = pct + '%';
          setSWUStatus(`Uploading… ${pct}%`);
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          try {
            const res = JSON.parse(xhr.responseText || '{}');
            if (xhr.status >= 200 && xhr.status < 300 && res.ok) {
              progressBar.style.width = '100%';
              setSWUStatus('Upload complete. You may now apply the update.', true, false);
              uploadedMeta = { filename: res.filename, path: res.path };
              applyBtn.disabled = false;
            } else {
              setSWUStatus(res.error || 'Upload failed.', false, true);
              uploadBtn.disabled = false;
            }
          } catch {
            setSWUStatus('Upload failed (invalid server response).', false, true);
            uploadBtn.disabled = false;
          }
        }
      };

      xhr.onerror = () => {
        setSWUStatus('Network error during upload.', false, true);
        uploadBtn.disabled = false;
      };

      xhr.send(formData);
    });

    // ===== Apply progress wiring (SSE + polling fallback) =====
    let swuES = null;
    let swuPoll = null;

    function clampPct(x) {
      const n = Number(x);
      if (!isFinite(n)) return null;
      return Math.max(0, Math.min(100, Math.round(n)));
    }

    function extractPercent(msg) {
      return (
        clampPct(msg.progress) ??
        clampPct(msg.cur_percent) ??
        clampPct(msg.percent) ??
        clampPct(msg.dwl_percent) ??
        null
      );
    }

    function formatStep(msg) {
      const step = (msg.cur_step != null && msg.nsteps != null)
        ? `Step ${msg.cur_step}/${msg.nsteps}`
        : null;
      const what = msg.cur_image || msg.hnd_name || msg.status || '';
      const info = msg.info ? ` — ${msg.info}` : '';
      return [step, what].filter(Boolean).join(' • ') + info;
    }

    function resetApplyProgress() {
      progressWrap.classList.remove('hidden');
      progressWrap.setAttribute('aria-hidden', 'false');
      progressBar.style.width = '0%';
    }

    let lastServerMsg = null;
    function appendServerLog(line) {
      const log = document.getElementById('swuLog');
      if (!log) return;
      const el = document.createElement('div');
      el.textContent = line;
      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    }

    function updateApplyUI(msg) {
      // prefer explicit server message text
      const serverText = msg.msg || msg.message || null;
      if (serverText) {
        appendServerLog(serverText);
      }

      const pct = extractPercent(msg);
      if (pct != null) {
        progressBar.style.width = pct + '%';
        setSWUStatus(serverText ? `${serverText} — ${pct}%` : `Applying… ${pct}%`);
      } else {
        setSWUStatus(serverText || 'Applying…');
      }
    }

    function finishApplyUI(ok, message) {
      if (ok) {
        progressBar.style.width = '100%';
        setSWUStatus(message || 'Update applied successfully.', true, false);

        document.getElementById('swuStatus').classList.add('status-ok');
        document.getElementById('swuStatus').classList.remove('status-err');

        // ✅ Add this for post-success reboot message
        setTimeout(() => {
          appendServerLog("Resetting in 5 seconds...");
          setSWUStatus("Resetting in 5 seconds...", true, false);
        }, 250);  // small delay after success message

      } else {
        setSWUStatus(message || 'Update failed.', false, true);
      }
      // Enable retry on failure; keep disabled on success if a reboot is expected
      applyBtn.disabled = ok;
    }

    function stopProgressWatchers() {
      if (swuES) { swuES.close(); swuES = null; }
      if (swuPoll) { clearInterval(swuPoll); swuPoll = null; }
    }

    function startSSE(jobId) {
      try {
        // use the /stream endpoint exposed by the server
        swuES = new EventSource(`/api/swu/progress/${encodeURIComponent(jobId)}/stream`);
        swuES.onmessage = (ev) => {
          let msg = {};
          try { msg = JSON.parse(ev.data || '{}'); } catch {}
          updateApplyUI(msg);
          const status = (msg.status || '').toUpperCase();
          if (msg.done || status === 'SUCCESS' || status === 'FAILED' || status === 'FAILURE' || status === 'DONE') {
            stopProgressWatchers();
            finishApplyUI(status === 'SUCCESS' || status === 'DONE', msg.message || msg.info || msg.msg);
          }
        };
        swuES.onerror = () => {
          // Fall back to polling if SSE drops
          stopProgressWatchers();
          startPolling(jobId);
        };
      } catch {
        startPolling(jobId);
      }
    }

    function startPolling(jobId) {
      swuPoll = setInterval(async () => {
        try {
          const r = await fetch(`/api/swu/progress/${encodeURIComponent(jobId)}`, { cache: 'no-store' });
          const msg = await r.json();
          if (!msg.ok && msg.status == null) throw new Error('bad response');
          updateApplyUI(msg);
          const status = (msg.status || '').toUpperCase();
          if (msg.done || status === 'SUCCESS' || status === 'FAILED' || status === 'FAILURE' || status === 'DONE') {
            stopProgressWatchers();
            finishApplyUI(status === 'SUCCESS' || status === 'DONE', msg.message || msg.info);
          }
        } catch {
          // keep trying
        }
      }, 1000);
    }

    async function onApplyUpdate(meta) {
      try {
        applyBtn.disabled = true;
        resetApplyProgress();
        setSWUStatus('Starting apply…');

        const res = await fetch('/api/swu/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(meta)
        });
        const data = await res.json();

        if (!res.ok || !data.ok || !data.job_id) {
          finishApplyUI(false, data.error || 'Failed to start apply.');
          return;
        }

        // Begin live progress
        startSSE(data.job_id);
      } catch {
        finishApplyUI(false, 'Network error starting apply.');
      }
    }

    applyBtn.addEventListener('click', () => {
      if (!uploadedMeta) {
        setSWUStatus('No uploaded file to apply.', false, true);
        return;
      }
      applyBtn.disabled = true;
      onApplyUpdate(uploadedMeta);
    });
  </script>
</body>
</html>
